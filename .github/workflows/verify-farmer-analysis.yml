name: Verify Farmer Analysis Script

on:
  # Run manually from Actions tab
  workflow_dispatch:
  
  # Run when script is updated
  push:
    paths:
      - 'excel-data/test-2-farmer-development/scripts/farmer_development_analysis.py'

jobs:
  verify-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # ========================================================================
    # VERIFICATION STEP 1: Check File Size
    # ========================================================================
    - name: üìè Check File Size
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 1: File Size Check"
        echo "=========================================="
        
        FILE="excel-data/test-2-farmer-development/scripts/farmer_development_analysis.py"
        
        if [ ! -f "$FILE" ]; then
          echo "‚ùå ERROR: Script file not found!"
          echo "Expected location: $FILE"
          exit 1
        fi
        
        SIZE=$(wc -c < "$FILE")
        SIZE_KB=$((SIZE / 1024))
        LINES=$(wc -l < "$FILE")
        
        echo "‚úì File found: $FILE"
        echo "‚úì File size: ${SIZE_KB} KB (${SIZE} bytes)"
        echo "‚úì Number of lines: ${LINES}"
        echo ""
        
        # Expected: 25-35 KB, 500-650 lines
        if [ $SIZE_KB -lt 20 ]; then
          echo "‚ö†Ô∏è  WARNING: File size is smaller than expected (< 20 KB)"
          echo "   Expected: 25-35 KB for complete script"
          echo "   Your file: ${SIZE_KB} KB"
          echo "   ‚Üí Script may be INCOMPLETE"
        elif [ $SIZE_KB -gt 40 ]; then
          echo "‚ö†Ô∏è  WARNING: File size is larger than expected (> 40 KB)"
          echo "   Expected: 25-35 KB"
          echo "   Your file: ${SIZE_KB} KB"
        else
          echo "‚úÖ File size looks good! (25-35 KB range)"
        fi
        
        echo ""
        
        if [ $LINES -lt 450 ]; then
          echo "‚ö†Ô∏è  WARNING: Line count is lower than expected (< 450 lines)"
          echo "   Expected: 500-650 lines for complete script"
          echo "   Your file: ${LINES} lines"
          echo "   ‚Üí Script may be INCOMPLETE"
        elif [ $LINES -gt 700 ]; then
          echo "‚ö†Ô∏è  WARNING: Line count is higher than expected (> 700 lines)"
          echo "   Expected: 500-650 lines"
          echo "   Your file: ${LINES} lines"
        else
          echo "‚úÖ Line count looks good! (500-650 lines range)"
        fi
        
        echo ""
        echo "=========================================="
    
    # ========================================================================
    # VERIFICATION STEP 2: Check Script Structure
    # ========================================================================
    - name: üîç Check Script Structure (Required Sections)
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 2: Script Structure"
        echo "=========================================="
        
        FILE="excel-data/test-2-farmer-development/scripts/farmer_development_analysis.py"
        
        echo "Checking for required sections..."
        echo ""
        
        MISSING=0
        
        # Check for required imports
        if grep -q "import pandas as pd" "$FILE"; then
          echo "‚úÖ Found: import pandas"
        else
          echo "‚ùå MISSING: import pandas"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "import numpy" "$FILE"; then
          echo "‚úÖ Found: import numpy"
        else
          echo "‚ùå MISSING: import numpy"
          MISSING=$((MISSING + 1))
        fi
        
        # Check for path configurations
        if grep -q "BASE_PATH" "$FILE"; then
          echo "‚úÖ Found: BASE_PATH configuration"
        else
          echo "‚ùå MISSING: BASE_PATH configuration"
          MISSING=$((MISSING + 1))
        fi
        
        # Check for required analysis sections
        if grep -q "ANALYSIS 1.1.*BASELINE DISTRIBUTION" "$FILE"; then
          echo "‚úÖ Found: Section 1.1 - Baseline Distribution"
        else
          echo "‚ùå MISSING: Section 1.1 - Baseline Distribution"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "ANALYSIS 1.2.*PROGRESS TRACKING" "$FILE"; then
          echo "‚úÖ Found: Section 1.2 - Progress Tracking"
        else
          echo "‚ùå MISSING: Section 1.2 - Progress Tracking"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "ANALYSIS 1.3.*PRODUCTION.*SEGMENTATION" "$FILE"; then
          echo "‚úÖ Found: Section 1.3 - Production Segmentation"
        else
          echo "‚ùå MISSING: Section 1.3 - Production Segmentation"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "ANALYSIS 1.4.*RECOMMENDATIONS" "$FILE"; then
          echo "‚úÖ Found: Section 1.4 - Data Quality Recommendations"
        else
          echo "‚ùå MISSING: Section 1.4 - Recommendations"
          MISSING=$((MISSING + 1))
        fi
        
        # Check for key column additions
        if grep -q "Adoption Level" "$FILE"; then
          echo "‚úÖ Found: Adoption Level column logic"
        else
          echo "‚ùå MISSING: Adoption Level column logic"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "Visit Tracking" "$FILE"; then
          echo "‚úÖ Found: Visit Tracking column logic"
        else
          echo "‚ùå MISSING: Visit Tracking column logic"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "Gender Farmer" "$FILE"; then
          echo "‚úÖ Found: Gender Farmer column logic"
        else
          echo "‚ùå MISSING: Gender Farmer column logic"
          MISSING=$((MISSING + 1))
        fi
        
        if grep -q "Land Size Category" "$FILE"; then
          echo "‚úÖ Found: Land Size Category column logic"
        else
          echo "‚ùå MISSING: Land Size Category column logic"
          MISSING=$((MISSING + 1))
        fi
        
        echo ""
        echo "=========================================="
        
        if [ $MISSING -eq 0 ]; then
          echo "‚úÖ PASSED: All required sections found!"
          echo "   Your script appears to be COMPLETE."
        else
          echo "‚ùå FAILED: ${MISSING} required sections are missing!"
          echo "   Your script is INCOMPLETE."
          echo ""
          echo "ACTION REQUIRED:"
          echo "1. Download the complete script from the artifacts"
          echo "2. Replace your current script"
          echo "3. Commit and push to fix this issue"
          exit 1
        fi
        
        echo "=========================================="
    
    # ========================================================================
    # VERIFICATION STEP 3: Check for Syntax Errors
    # ========================================================================
    - name: üêç Check Python Syntax
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 3: Python Syntax Check"
        echo "=========================================="
        
        FILE="excel-data/test-2-farmer-development/scripts/farmer_development_analysis.py"
        
        if python -m py_compile "$FILE"; then
          echo "‚úÖ PASSED: No syntax errors found!"
          echo "   Python can parse the script successfully."
        else
          echo "‚ùå FAILED: Syntax errors detected!"
          echo "   Please fix the syntax errors before running."
          exit 1
        fi
        
        echo "=========================================="
    
    # ========================================================================
    # VERIFICATION STEP 4: Install Dependencies
    # ========================================================================
    - name: üì¶ Install Dependencies
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 4: Install Dependencies"
        echo "=========================================="
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl xlrd
        echo "‚úÖ All dependencies installed successfully!"
        echo "=========================================="
    
    # ========================================================================
    # VERIFICATION STEP 5: Create Required Directories
    # ========================================================================
    - name: üìÅ Create Required Directories
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 5: Setup Directories"
        echo "=========================================="
        mkdir -p excel-data/test-2-farmer-development/cleaned
        mkdir -p excel-data/test-2-farmer-development/results
        echo "‚úÖ Directories created successfully!"
        ls -la excel-data/test-2-farmer-development/
        echo "=========================================="
    
    # ========================================================================
    # TEST: Run the Script
    # ========================================================================
    - name: üöÄ TEST - Run Analysis Script
      id: run_script
      run: |
        echo "=========================================="
        echo "RUNNING FULL ANALYSIS TEST"
        echo "=========================================="
        echo ""
        echo "Starting analysis script..."
        echo "This will take 2-3 minutes..."
        echo ""
        
        cd excel-data/test-2-farmer-development/scripts
        
        # Run the script and capture output
        if python farmer_development_analysis.py 2>&1 | tee ../../../analysis_output.log; then
          echo ""
          echo "=========================================="
          echo "‚úÖ SCRIPT RAN SUCCESSFULLY!"
          echo "=========================================="
        else
          echo ""
          echo "=========================================="
          echo "‚ùå SCRIPT FAILED TO RUN!"
          echo "=========================================="
          echo ""
          echo "Check the error messages above."
          echo "Common issues:"
          echo "  - Missing raw data file"
          echo "  - Incorrect column names in Excel"
          echo "  - Incomplete script"
          exit 1
        fi
      continue-on-error: true
    
    # ========================================================================
    # VERIFICATION STEP 6: Verify Output Files
    # ========================================================================
    - name: üìä Verify Generated Output Files
      run: |
        echo "=========================================="
        echo "VERIFICATION STEP 6: Check Output Files"
        echo "=========================================="
        echo ""
        
        CLEANED_DIR="excel-data/test-2-farmer-development/cleaned"
        RESULTS_DIR="excel-data/test-2-farmer-development/results"
        
        MISSING_FILES=0
        
        # Expected files
        declare -a EXPECTED_FILES=(
          "$CLEANED_DIR/test_2_farmer_development_cleaned.csv"
          "$RESULTS_DIR/1.1_baseline_result_distribution.csv"
          "$RESULTS_DIR/1.1_baseline_competence_distribution.csv"
          "$RESULTS_DIR/1.2_progress_tracking_detailed.csv"
          "$RESULTS_DIR/1.2_progress_tracking_summary.csv"
          "$RESULTS_DIR/1.3_production_by_gender.csv"
          "$RESULTS_DIR/1.3_production_by_landsize.csv"
          "$RESULTS_DIR/1.3_production_summary.csv"
          "$RESULTS_DIR/1.4_data_quality_recommendations.txt"
        )
        
        echo "Checking for 9 expected output files..."
        echo ""
        
        for file in "${EXPECTED_FILES[@]}"; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            echo "‚úÖ Found: $(basename $file) (${SIZE})"
          else
            echo "‚ùå MISSING: $(basename $file)"
            MISSING_FILES=$((MISSING_FILES + 1))
          fi
        done
        
        echo ""
        echo "=========================================="
        
        if [ $MISSING_FILES -eq 0 ]; then
          echo "‚úÖ SUCCESS: All 9 output files generated!"
          echo ""
          echo "Your script is COMPLETE and WORKING!"
          echo ""
          echo "Files generated:"
          echo "  - 1 cleaned data file"
          echo "  - 8 analysis result files"
        else
          echo "‚ùå FAILED: ${MISSING_FILES} files are missing!"
          echo ""
          echo "Possible reasons:"
          echo "  1. Script is incomplete"
          echo "  2. Raw data file is missing"
          echo "  3. Script encountered errors"
          echo ""
          echo "Please check the analysis output above for error messages."
        fi
        
        echo "=========================================="
    
    # ========================================================================
    # Generate Summary Report
    # ========================================================================
    - name: üìã Generate Verification Report
      if: always()
      run: |
        echo "=========================================="
        echo "VERIFICATION SUMMARY REPORT"
        echo "=========================================="
        echo ""
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        
        FILE="excel-data/test-2-farmer-development/scripts/farmer_development_analysis.py"
        
        if [ -f "$FILE" ]; then
          SIZE_KB=$(($(wc -c < "$FILE") / 1024))
          LINES=$(wc -l < "$FILE")
          echo "Script File: ‚úÖ Found"
          echo "  - Size: ${SIZE_KB} KB"
          echo "  - Lines: ${LINES}"
        else
          echo "Script File: ‚ùå Not Found"
        fi
        
        echo ""
        
        if [ -d "excel-data/test-2-farmer-development/cleaned" ]; then
          CLEANED_COUNT=$(ls -1 excel-data/test-2-farmer-development/cleaned/*.csv 2>/dev/null | wc -l)
          echo "Cleaned Data: ${CLEANED_COUNT} file(s) generated"
        else
          echo "Cleaned Data: 0 files (directory not found)"
        fi
        
        if [ -d "excel-data/test-2-farmer-development/results" ]; then
          RESULTS_COUNT=$(ls -1 excel-data/test-2-farmer-development/results/* 2>/dev/null | wc -l)
          echo "Analysis Results: ${RESULTS_COUNT} file(s) generated"
        else
          echo "Analysis Results: 0 files (directory not found)"
        fi
        
        echo ""
        echo "=========================================="
        echo ""
        
        TOTAL_EXPECTED=9
        TOTAL_FOUND=$((CLEANED_COUNT + RESULTS_COUNT))
        
        if [ $TOTAL_FOUND -eq $TOTAL_EXPECTED ]; then
          echo "üéâ OVERALL RESULT: COMPLETE & WORKING"
          echo ""
          echo "Your script is fully functional!"
          echo "All ${TOTAL_EXPECTED} expected files were generated."
          echo ""
          echo "Next steps:"
          echo "  1. Download the analysis results from artifacts"
          echo "  2. Use the results to create your 2-pager report"
          echo "  3. Proceed to Exercise 2 and 3"
        else
          echo "‚ö†Ô∏è  OVERALL RESULT: INCOMPLETE OR NOT WORKING"
          echo ""
          echo "Expected: ${TOTAL_EXPECTED} files"
          echo "Found: ${TOTAL_FOUND} files"
          echo ""
          echo "Action required:"
          echo "  1. Review the error messages above"
          echo "  2. Check if raw data file exists"
          echo "  3. Consider replacing script with complete version"
        fi
        
        echo ""
        echo "=========================================="
    
    # ========================================================================
    # Upload Results as Artifacts
    # ========================================================================
    - name: üì§ Upload Analysis Output Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-output-log
        path: analysis_output.log
        retention-days: 30
    
    - name: üì§ Upload Cleaned Data (if generated)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cleaned-data-output
        path: excel-data/test-2-farmer-development/cleaned/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: üì§ Upload Analysis Results (if generated)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results-output
        path: excel-data/test-2-farmer-development/results/
        retention-days: 30
        if-no-files-found: ignore
    
    # ========================================================================
    # Final Status
    # ========================================================================
    - name: ‚úÖ Verification Complete
      run: |
        echo ""
        echo "=========================================="
        echo "VERIFICATION WORKFLOW COMPLETED"
        echo "=========================================="
        echo ""
        echo "Check the steps above for detailed results."
        echo "Download artifacts to review generated files."
        echo ""
        echo "=========================================="
