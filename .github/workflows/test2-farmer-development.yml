name: Test 2 - Farmer Development Analysis

on:
  push:
    branches:
      - main
    paths:
      - 'excel-data/test-2-farmer-development/raw/**'
      - 'excel-data/test-2-farmer-development/scripts/**'
      - '.github/workflows/test2-farmer-development.yml'
  workflow_dispatch:
    inputs:
      run_exercise:
        description: 'Which exercise to run (all, 1, 2, 3)'
        required: false
        default: 'all'

jobs:
  farmer-development-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        # Removed cache: 'pip' to fix the error
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl matplotlib seaborn numpy

    - name: ðŸ“‚ Create directory structure
      run: |
        python -c "
        from pathlib import Path
        
        base = Path('excel-data/test-2-farmer-development')
        dirs = [
            'raw', 'scripts/exercise-1-analysis', 'scripts/exercise-2-dashboard',
            'scripts/exercise-3-data-collection', 'cleaned',
            'results/exercise-1-analysis/figures',
            'results/exercise-1-analysis/analysis_report_2pager',
            'results/exercise-2-dashboard/dashboard_design',
            'results/exercise-3-data-collection/budget_breakdown',
            'results/exercise-3-data-collection/gantt_chart'
        ]
        
        for d in dirs:
            (base / d).mkdir(parents=True, exist_ok=True)
            print(f'âœ“ Created: {base / d}')
        "

    - name: âœ… Verify raw data exists
      run: |
        if [ ! -f "excel-data/test-2-farmer-development/raw/test_2_farmer_development_raw.xlsx" ]; then
          echo "âš ï¸ Raw data file not found!"
          echo "Expected: excel-data/test-2-farmer-development/raw/test_2_farmer_development_raw.xlsx"
          exit 1
        fi
        echo "âœ“ Raw data file found"
    
    - name: ðŸ“Š Exercise 1 - Farmer Development Analysis
      if: github.event.inputs.run_exercise == 'all' || github.event.inputs.run_exercise == '1' || github.event.inputs.run_exercise == ''
      run: |
        echo "================================================"
        echo "Running Exercise 1: Farmer Development Analysis"
        echo "================================================"
        
        # Check if script exists
        if [ ! -f "excel-data/test-2-farmer-development/scripts/exercise-1-analysis/exercise_1_farmer_analysis.py" ]; then
          echo "âŒ ERROR: exercise_1_farmer_analysis.py not found!"
          echo "Please ensure the script is saved in: excel-data/test-2-farmer-development/scripts/exercise-1-analysis/"
          exit 1
        fi
        
        # Run the script
        python excel-data/test-2-farmer-development/scripts/exercise-1-analysis/exercise_1_farmer_analysis.py
        
        echo "âœ… Exercise 1 completed"
    
    - name: ðŸŽ¨ Exercise 2 - Living Income Dashboard Design
      if: github.event.inputs.run_exercise == 'all' || github.event.inputs.run_exercise == '2' || github.event.inputs.run_exercise == ''
      run: |
        echo "================================================"
        echo "Running Exercise 2: Living Income Dashboard"
        echo "================================================"
        
        # Check if script exists
        if [ ! -f "excel-data/test-2-farmer-development/scripts/exercise-2-dashboard/exercise_2_living_income_dashboard.py" ]; then
          echo "âŒ ERROR: exercise_2_living_income_dashboard.py not found!"
          echo "Please ensure the script is saved in: excel-data/test-2-farmer-development/scripts/exercise-2-dashboard/"
          exit 1
        fi
        
        # Run the script
        python excel-data/test-2-farmer-development/scripts/exercise-2-dashboard/exercise_2_living_income_dashboard.py
        
        echo "âœ… Exercise 2 completed"
    
    - name: ðŸ“… Exercise 3 - Data Collection Planning
      if: github.event.inputs.run_exercise == 'all' || github.event.inputs.run_exercise == '3' || github.event.inputs.run_exercise == ''
      run: |
        echo "================================================"
        echo "Running Exercise 3: Data Collection Planning"
        echo "================================================"
        
        # Check if script exists
        if [ ! -f "excel-data/test-2-farmer-development/scripts/exercise-3-data-collection/exercise_3_data_collection.py" ]; then
          echo "âŒ ERROR: exercise_3_data_collection.py not found!"
          echo "Please ensure the script is saved in: excel-data/test-2-farmer-development/scripts/exercise-3-data-collection/"
          exit 1
        fi
        
        # Run the script
        python excel-data/test-2-farmer-development/scripts/exercise-3-data-collection/exercise_3_data_collection.py
        
        echo "âœ… Exercise 3 completed"

    - name: ðŸ“Š Generate summary report
      run: |
        echo "================================================"
        echo "FARMER DEVELOPMENT ANALYSIS - SUMMARY"
        echo "================================================"
        echo ""
        echo "âœ… Exercise 1: Baseline analysis, progress tracking, production segmentation"
        echo "âœ… Exercise 2: Living Income Dashboard design with mockups"
        echo "âœ… Exercise 3: Data collection plan with budget and timeline"
        echo ""
        echo "ðŸ“‚ Results saved to: excel-data/test-2-farmer-development/results/"
        echo ""
        
        # Create summary file
        cat > excel-data/test-2-farmer-development/results/ANALYSIS_SUMMARY.txt << 'EOF'
        ================================================================================
        TEST 2: FARMER DEVELOPMENT PLAN ANALYSIS - SUMMARY
        ================================================================================
        
        EXERCISE 1: Analysis of Farmer Development Data
        ------------------------------------------------
        âœ“ Baseline adoption and competence analysis completed
        âœ“ Progress tracking between Visit 1 and Visit 2 analyzed
        âœ“ Production segmentation by gender and land size completed
        âœ“ Data quality recommendations generated
        
        Results Location:
        - Figures: results/exercise-1-analysis/figures/
        - Report: results/exercise-1-analysis/analysis_report_2pager/
        - Cleaned Data: cleaned/
        
        EXERCISE 2: Living Income Dashboard Design
        -------------------------------------------
        âœ“ Dashboard mockup with 7 key visualizations created
        âœ“ Design rationale documented
        âœ“ Component formulas and data requirements specified
        
        Results Location:
        - Dashboard Design: results/exercise-2-dashboard/dashboard_design/
        
        EXERCISE 3: Data Collection System Setup
        -----------------------------------------
        âœ“ Optimal data collection approach selected (2 Consultant Surveyors)
        âœ“ Budget breakdown created (Total: ~3,907 EUR)
        âœ“ Project Gantt chart generated
        âœ“ Implementation plan with sampling strategy documented
        
        Results Location:
        - Budget: results/exercise-3-data-collection/budget_breakdown/
        - Timeline: results/exercise-3-data-collection/gantt_chart/
        - Plan: results/exercise-3-data-collection/data_collection_plan.txt
        
        ================================================================================
        Analysis completed: $(date)
        ================================================================================
        EOF
        
        cat excel-data/test-2-farmer-development/results/ANALYSIS_SUMMARY.txt
    
    - name: ðŸ“¤ Upload results as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: farmer-development-analysis-results
        path: |
          excel-data/test-2-farmer-development/results/
          excel-data/test-2-farmer-development/cleaned/
        retention-days: 30
    
    - name: ðŸ’¾ Commit results back to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add excel-data/test-2-farmer-development/results/ || true
        git add excel-data/test-2-farmer-development/cleaned/ || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ¤– Auto-update: Test 2 Farmer Development Analysis Results"
          git push
        fi
